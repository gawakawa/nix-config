name: Cache nixpkgs

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (e.g., refs/pull/23/merge, main)"
        required: true
        type: string
      package:
        description: "Package to build (e.g., swift-system)"
        required: true
        type: string
      platform:
        description: "Runner platform"
        required: true
        type: choice
        options:
          - macos-latest
          - ubuntu-latest

jobs:
  build:
    runs-on: ${{ inputs.platform }}
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref }}

      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - uses: cachix/cachix-action@v16
        with:
          name: gawakawa
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - run: nix build "nixpkgs#${{ inputs.package }}" --inputs-from .
